
<div class="header pb-8 pt-5 pt-lg-8 d-flex align-items-center"
  style="min-height: 200px; background-size: cover; background-position: center top;">
  <!-- Mask -->
  <span class="mask bg-gradient-danger opacity-8"></span>
  <!-- Header container -->

</div>
<div class="container-fluid mt--7">
  <div class="row">
    <div class="col-xl-3 order-xl-2 mb-5 mb-xl-0">
      <div class="card card-profile shadow">
        <div class="row justify-content-center">
          <div class="col-lg-3 order-lg-2">

            <div class="card-profile-image">
              <a>
                <img src="{{previewURL}}" class="rounded-circle">
              </a>

            </div>
          </div>
        </div>
        <div class="card-header text-center border-0 pt-8 pt-md-4 pb-0 pb-md-4">
          <div class="d-flex justify-content-between">


          </div>
        </div>
        <div class="card-body pt-0 pt-md-4">
          <div class="row">
            <div class="col">
              <div class="card-profile-stats d-flex justify-content-center mt-md-5">
                <div>
                  <div class="custom-file">
                    <input #imageInput placeholder="Logo Matière" accept="image/*" lang="fr"
                      (change)="addImage(imageInput)" type="file" class="custom-file-input" id="customFile">
                    <label class="custom-file-label" for="customFile">
                      Choisir le fichier</label>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-9 order-xl-1">
      <div class="card bg-secondary shadow">
        <div class="card-header bg-white border-0">
          <div class="row align-items-center">
            <div class="col-8">
              <h3 class="mb-0">Mettre a jour Matiere</h3>
            </div>
            <div class="col-4 text-right">
            </div>
          </div>
        </div>
        <div class="card-body">
          <form [formGroup]="formMatiere">
            <!-- Description -->
            <h6 class="heading-small text-muted mb-4">Informations de Matière</h6>
            <div class="pl-lg-4 row">
                <div class="form-group col-6">
                  <label for="reference">Reference<span class="champs-obligatoire">*</span></label>
                  <input type="text" formControlName="reference" name="reference" class="form-control"
                    placeholder="Saisir la référence*" value=""
                    [ngClass]="{ 'is-invalid': ft.reference.errors && ft.reference.touched }" />
                  <div *ngIf="ft.reference.errors && ft.reference.touched" class="invalid-feedback">
                    <div *ngIf="ft.reference.errors.required">Reference requise</div>
                  </div>
                </div>
                <div class="form-group col-6">
                  <label for="name">Désignation<span class="champs-obligatoire">*</span></label>
                  <input type="text" formControlName="designation" name="name" class="form-control"
                    placeholder="Saisir la designation*" value=""
                    [ngClass]="{ 'is-invalid': ft.designation.errors && ft.designation.touched }" />
                  <div *ngIf="ft.designation.errors && ft.designation.touched" class="invalid-feedback">
                    <div *ngIf="ft.designationerrors.required">La designation est requise</div>
                  </div>
                </div>
            </div>
            <hr class="my-4" />
            <h6 class="heading-small text-muted mb-2">Gestion de stock</h6>
            <div class="pl-lg-4 row">
              <div class="form-group col-6">
                <label for="stock">Stock initial<span class="champs-obligatoire">*</span></label>
                <input type="number" onkeypress="return event.charCode >= 48" min="1" formControlName="stock" name="stock" class="form-control"
                  placeholder="Saisir le stock initial" value=""
                  [ngClass]="{ 'is-invalid': ft.stock.errors && ft.stock.touched}" />
                  <div *ngIf="ft.stock_max.errors && ft.stock_max.touched" class="invalid-feedback">
                    <div *ngIf="ft.stock_max.errors.required">Stock initial requis</div>
                    <div *ngIf="ft.stock_max.errors.min">Stock initial doit être supérieur a 0</div>
                  </div>
              </div>
              <div class="form-group col-6">
                <label for="prix">Prix de reference<span class="champs-obligatoire">*</span></label>
                <input type="number" onkeypress="return event.charCode >= 48" step="0.001" min="0.1" formControlName="prix_achat" name="prix" class="form-control"
                  placeholder="Saisir le prix d'achat" value=""
                  [ngClass]="{ 'is-invalid': ft.prix_achat.errors && ft.prix_achat.touched }" />
                  <div *ngIf="ft.stock_max.errors && ft.prix_achat.touched" class="invalid-feedback">
                    <div *ngIf="ft.prix_achat.errors.required">Prix de reference requis</div>
                    <div *ngIf="ft.prix_achat.errors.min">Le prix de reference doit être supérieur a 0</div>
                  </div>
              </div>
              <div class="form-group col-6">
                <label for="stocksec">Stock de sécurité<span class="champs-obligatoire">*</span></label>
                <input type="number" onkeypress="return event.charCode >= 48" min="1" formControlName="stock_securite" name="stocksec" class="form-control"
                  placeholder="Saisir le stock de securité*" value=""
                  [ngClass]="{ 'is-invalid': ft.stock_securite.errors && ft.stock_securite.touched }" />
                <div *ngIf="ft.stock_securite.errors && ft.stock_securite.touched" class="invalid-feedback">
                  <div *ngIf="ft.stock_securite.errors.required">Stock de sécurité requis</div>
                  <div *ngIf="ft.stock_securite.errors.min">Stock de sécurité doit être supérieur a 0</div>
                </div>
              </div>
              <div class="form-group col-6">
                <label for="stockmax">Stock maximale<span class="champs-obligatoire">*</span></label>
                <input type="number" onkeypress="return event.charCode >= 48" min="1" formControlName="stock_max" name="stockmax" class="form-control"
                  placeholder="Saisir le stock maximale*" value=""
                  [ngClass]="{ 'is-invalid': ft.stock_max.errors && ft.stock_max.touched}" />
                <div *ngIf="ft.stock_max.errors && ft.stock_max.touched" class="invalid-feedback">
                  <div *ngIf="ft.stock_max.errors.required">Stock maximale requis</div>
                  <div *ngIf="ft.stock_max.errors.min">Stock maximale doit être supérieur a 0</div>
                </div>
              </div>

            </div>
            <hr class="my-4" />
            <h6 class="heading-small text-muted mb-2">Sécurité et qualité</h6>
            <div class="pl-lg-4 row">
              <div class="form-group col-6">
                <label for="consigne">Consigne de securité</label>
                <textarea type="text" formControlName="mesure_securite" name="name" rows="3" class="form-control"
                  placeholder="Saisir les consignes de securité" value=""
                  [ngClass]="{ 'is-invalid':ft.mesure_securite.errors && ft.mesure_securite.touched }"></textarea>
              </div>
              <div class="form-group col-6">
                <label for="norme">Norme de qualité</label>
                <textarea type="text" formControlName="norme_qualite" name="norme" rows="3" class="form-control"
                  placeholder="Saisir les normes de qualité" value=""
                  [ngClass]="{ 'is-invalid':ft.norme_qualite.errors && ft.norme_qualite.touched }"></textarea>
              </div>
            </div>
            <hr class="my-4" />
            <h6 class="heading-small text-muted mb-2">choix de fournisseur</h6>
            <div class="pl-lg-4 row">
              <form class="col-12" [formGroup]="fournisseurTable">
                <table class="table mat-elevation-z8 align-items-center table-flush">
                  <thead>
                    <th>#</th>
                    <th>Raison sociale</th>
                    <th>Prix (HT)</th>
                  </thead>
                  <tbody>
                    <ng-container formArrayName="tableRows"
                      *ngFor="let group of getFormControls.controls ; let i=index">
                      <tr *ngIf="group.get('isEditable').value" [formGroupName]="i">
                        <td>
                          <div class="form-group">
                            <mat-form-field style="max-width: 100px;">
                              <mat-select [formControl]="fournisseur"
                                placeholder="Reference search"
                                (selectionChange)="selectFournisseur($event,i);doneRow(group);addRow()">
                                <mat-option>
                                  <ngx-mat-select-search [formControl]="searchRefCtrl" placeholderLabel="Rechercher..."
                                    noEntriesFoundLabel="Aucun fournisseur trouvé">
                                  </ngx-mat-select-search>
                                </mat-option>
                                <ng-container *ngFor="let fournisseur of filteredFournisseur">
                                <mat-option *ngIf="!fours.includes(fournisseur._id)" [value]="fournisseur">
                                  {{fournisseur.mat_fis}}
                                </mat-option>
                              </ng-container>
                              </mat-select>
                            </mat-form-field>
                          </div>
                        </td>

                        <td>
                          <div class="form-group">
                            <mat-form-field>
                              <mat-select [formControl]="fournisseur" 
                                placeholder="Fournisseur search"
                                (selectionChange)="selectFournisseur($event,i);doneRow(group);addRow()" #singleSelect>
                                <mat-option>
                                  <ngx-mat-select-search [formControl]="searchNameCtrl" placeholderLabel="Rechercher..."
                                    noEntriesFoundLabel="Aucun fournisseur trouvé">
                                  </ngx-mat-select-search>
                                </mat-option>
                                <mat-option *ngFor="let fournisseur of filteredFournisseur" [value]="fournisseur">
                                  {{fournisseur.name}}
                                </mat-option>
                              </mat-select>
                            </mat-form-field>

                          </div>
                        </td>
        
                        <td>
                          <div class="form-group">
                            <input type="number" onkeypress="return event.charCode >= 48" min="1" formControlName="prix_ht" step="any" (change)="changePrix(i)" class="form-control"
                              placeholder="" />
                          </div>
                        </td>



                      </tr>
                      <tr *ngIf="!group.get('isEditable').value" [formGroupName]="i">
                        <td>
                          {{group.get('ref').value}}
                        </td>
                        <td>
                          {{group.get('name').value}}
                        </td>
                        <td>
                          <input type="number" onkeypress="return event.charCode >= 48" min="1" formControlName="prix_ht" (change)="changePrix(i)" class="form-control"
                            placeholder="" />
                        </td>
                        <td class="action-container">
                          <mat-icon class="delete pos-relative" (click)="deleteRow(i)">delete_forever</mat-icon>
                        </td>
                      </tr>
                    </ng-container>
                  </tbody>
                </table>
              </form>
            </div>
            
            <div class="text-center mt-5">
                <button (click)="onUpdateMatiereSubmit()" [ngClass]="{ 'btn-danger': formMatiere.invalid || matiereFournisseurs.length == 0 , 'btn-success': !formMatiere.invalid && matiereFournisseurs}" type="submit" class="btn pull-right"
                  [disabled]="formMatiere.invalid || matiereFournisseurs.length == 0">Mettre a jour matiere</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
